# Promtail configuration for crypto arbitrage trading system
# Collects logs from application and Docker containers

server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: info

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push
    backoff_config:
      min_period: 500ms
      max_period: 5m
      max_retries: 10
    timeout: 10s

scrape_configs:
  # Application logs from files
  - job_name: trading_app_logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: trading_app
          environment: production
          __path__: /var/log/trading/*.log

    pipeline_stages:
      # Parse JSON logs
      - json:
          expressions:
            timestamp: timestamp
            level: level
            logger: logger
            message: message
            event: event
            symbol: symbol
            profit: profit
            edge_bps: edge_bps
            gas_cost: gas_cost
            tx_hash: tx_hash

      # Extract labels
      - labels:
          level:
          logger:
          event:
          symbol:

      # Parse timestamp
      - timestamp:
          source: timestamp
          format: RFC3339Nano

      # Drop debug logs in production (optional)
      # - match:
      #     selector: '{level="DEBUG"}'
      #     action: drop

  # Docker container logs
  - job_name: docker_containers
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s

    relabel_configs:
      # Only scrape containers in trading_network
      - source_labels: ['__meta_docker_network_name']
        regex: 'trading_network'
        action: keep

      # Set container name as label
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: 'container'

      # Set container image as label
      - source_labels: ['__meta_docker_container_image']
        target_label: 'image'

      # Add service label based on container name
      - source_labels: ['__meta_docker_container_name']
        regex: '/trading_(.*)'
        target_label: 'service'
        replacement: '${1}'

    pipeline_stages:
      # Attempt to parse JSON logs from containers
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message

      # Extract level if available
      - labels:
          level:

      # If JSON parsing fails, treat as plain text
      - match:
          selector: '{job="docker_containers"}'
          stages:
            - regex:
                expression: '^(?P<time>[^ ]+) (?P<stream>stdout|stderr) (?P<flags>[^ ]*) (?P<message>.*)$'
            - labels:
                stream:

  # TimescaleDB PostgreSQL logs
  - job_name: timescaledb_logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: timescaledb
          component: database
          environment: production

    # TimescaleDB logs from Docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s

    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '.*timescaledb.*'
        action: keep

    pipeline_stages:
      # Parse PostgreSQL log format
      - regex:
          expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3}) (?P<timezone>\w+) \[(?P<pid>\d+)\] (?P<level>\w+):\s+(?P<message>.*)$'

      - labels:
          level:
          pid:

      - timestamp:
          source: timestamp
          format: '2006-01-02 15:04:05.000'

  # Prometheus logs
  - job_name: prometheus_logs
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s

    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '.*prometheus.*'
        action: keep

      - source_labels: ['__meta_docker_container_name']
        target_label: 'service'
        replacement: 'prometheus'

  # Grafana logs
  - job_name: grafana_logs
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s

    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '.*grafana.*'
        action: keep

      - source_labels: ['__meta_docker_container_name']
        target_label: 'service'
        replacement: 'grafana'

    pipeline_stages:
      # Parse Grafana log format
      - regex:
          expression: '^t=(?P<timestamp>[^ ]+) lvl=(?P<level>\w+) msg="(?P<message>[^"]*)"'

      - labels:
          level:

# Limits
limits_config:
  readline_rate: 10000
  readline_burst: 20000
  max_streams: 10000
