<!-- AI/ML ON-CHAIN WIDGET - Insert this after line 586 in web_dashboard.html -->
<!-- This goes in the settings-flex div alongside the AI Settings (off-chain) card -->

<div class="settings-card" style="border: 2px solid #f59e0b;">
    <h3 style="margin:0 0 12px 0;font-size:14px;color:#f59e0b;display:flex;align-items:center;justify-content:space-between;">
        <span><span class="emoji">‚ö°ü§ñ</span> AI/ML On-Chain (Flash Loans)</span>
        <span class="pill" id="aiOnChainStatus" style="background:#fef3c7;color:#92400e;font-size:0.75em;">OFF</span>
    </h3>

    <!-- Quick Preset Buttons -->
    <div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;">
        <button onclick="applyAIPreset('conservative')" style="flex:1;padding:6px 10px;font-size:0.8em;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;">
            üõ°Ô∏è Conservative
        </button>
        <button onclick="applyAIPreset('balanced')" style="flex:1;padding:6px 10px;font-size:0.8em;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;">
            ‚öñÔ∏è Balanced
        </button>
        <button onclick="applyAIPreset('aggressive')" style="flex:1;padding:6px 10px;font-size:0.8em;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;">
            üöÄ Aggressive
        </button>
    </div>

    <div class="config-grid" style="display:grid;grid-template-columns:1fr;gap:10px;">
        <!-- AI Mode Selection -->
        <div>
            <div class="stat-label">AI Mode</div>
            <select id="aiModeSelect" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e5e7eb;">
                <option value="conservative">Conservative (70% confidence, 2x leverage)</option>
                <option value="balanced" selected>Balanced (65% confidence, 3x leverage)</option>
                <option value="aggressive">Aggressive (60% confidence, 5x leverage)</option>
            </select>
        </div>

        <!-- Capital and Target -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <div>
                <div class="stat-label">Current Capital (ETH)</div>
                <input type="number" id="currentCapitalEth" step="1" value="100" min="1" style="width:100%;padding:6px;border-radius:6px;border:1px solid #e5e7eb;">
            </div>
            <div>
                <div class="stat-label">Target Capital (ETH)</div>
                <input type="number" id="targetCapitalEth" step="10" value="1000" min="10" style="width:100%;padding:6px;border-radius:6px;border:1px solid #e5e7eb;">
            </div>
        </div>

        <!-- Growth Multiplier Display -->
        <div style="background:#f0fdf4;padding:8px;border-radius:6px;text-align:center;">
            <div style="font-size:0.75em;color:#166534;margin-bottom:2px;">Target Growth</div>
            <div style="font-size:1.3em;font-weight:bold;color:#15803d;" id="growthMultiplier">10.0x</div>
        </div>

        <!-- AI Confidence Threshold -->
        <div>
            <div class="stat-label">
                AI Confidence Threshold
                <span style="float:right;color:#6366f1;font-weight:bold;" id="aiConfidenceValue">0.70</span>
            </div>
            <input type="range" id="aiOnChainConfidence" min="0.50" max="0.90" step="0.05" value="0.70"
                   style="width:100%;" oninput="updateAIConfidenceDisplay(this.value)">
            <div style="display:flex;justify-content:space-between;font-size:0.7em;color:#9ca3af;margin-top:2px;">
                <span>0.50 (Risky)</span>
                <span>0.90 (Safe)</span>
            </div>
        </div>

        <!-- Flash Loan Min Profit -->
        <div>
            <div class="stat-label">
                Min Flash Profit (ETH)
                <span style="float:right;color:#10b981;font-weight:bold;" id="flashProfitValue">0.15</span>
            </div>
            <input type="range" id="flashLoanMinProfit" min="0.05" max="0.50" step="0.05" value="0.15"
                   style="width:100%;" oninput="updateFlashProfitDisplay(this.value)">
            <div style="display:flex;justify-content:space-between;font-size:0.7em;color:#9ca3af;margin-top:2px;">
                <span>0.05 (More opps)</span>
                <span>0.50 (Safer)</span>
            </div>
        </div>

        <!-- Position Sizing Settings -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <div>
                <div class="stat-label">Kelly Fraction</div>
                <input type="number" id="kellyFraction" step="0.05" value="0.25" min="0.1" max="0.5" style="width:100%;padding:6px;border-radius:6px;border:1px solid #e5e7eb;">
            </div>
            <div>
                <div class="stat-label">Max Leverage</div>
                <input type="number" id="maxLeverage" step="0.5" value="3.0" min="1.0" max="10.0" style="width:100%;padding:6px;border-radius:6px;border:1px solid #e5e7eb;">
            </div>
        </div>

        <!-- Risk Management -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <div>
                <div class="stat-label">Max Daily Losses ($)</div>
                <input type="number" id="maxDailyLosses" step="50" value="500" min="100" style="width:100%;padding:6px;border-radius:6px;border:1px solid #e5e7eb;">
            </div>
            <div>
                <div class="stat-label">Max Concurrent</div>
                <input type="number" id="maxConcurrent" step="1" value="3" min="1" max="10" style="width:100%;padding:6px;border-radius:6px;border:1px solid #e5e7eb;">
            </div>
        </div>

        <!-- Toggles -->
        <div style="display:flex;flex-direction:column;gap:6px;">
            <label class="toggle" style="background:#f0fdf4;cursor:pointer;">
                <input type="checkbox" id="enableAIOrchestration" checked>
                <span style="font-size:0.85em;">üéØ Enable AI Orchestration</span>
            </label>
            <label class="toggle" style="background:#fef3c7;cursor:pointer;">
                <input type="checkbox" id="enableProfitMaximization" checked>
                <span style="font-size:0.85em;">üí∞ Profit Maximization (Aggressive)</span>
            </label>
            <label class="toggle" style="background:#f0fdf4;cursor:pointer;">
                <input type="checkbox" id="enableMLScoring" checked>
                <span style="font-size:0.85em;">üß† ML Model Scoring</span>
            </label>
            <label class="toggle" style="background:#fee2e2;cursor:pointer;">
                <input type="checkbox" id="enableFlashLoans" checked>
                <span style="font-size:0.85em;">‚ö° Flash Loans Enabled</span>
            </label>
        </div>

        <!-- Apply Button -->
        <button onclick="applyAIOnChainConfig()" style="width:100%;padding:12px;background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);color:white;border:none;border-radius:8px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-top:4px;">
            <span class="emoji">üíæ</span> Apply AI On-Chain Config
        </button>
    </div>

    <!-- Stats Display -->
    <div style="margin-top:12px;padding:10px;background:#f9fafb;border-radius:6px;font-size:0.8em;">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
            <div>
                <div style="color:#6b7280;">AI Decisions</div>
                <div style="font-weight:bold;color:#1f2937;" id="aiDecisionsCount">0</div>
            </div>
            <div>
                <div style="color:#6b7280;">Executions</div>
                <div style="font-weight:bold;color:#1f2937;" id="aiExecutionsCount">0</div>
            </div>
            <div>
                <div style="color:#6b7280;">Win Rate</div>
                <div style="font-weight:bold;color:#10b981;" id="aiWinRate">--%</div>
            </div>
            <div>
                <div style="color:#6b7280;">Progress</div>
                <div style="font-weight:bold;color:#f59e0b;" id="aiProgress">0.0%</div>
            </div>
        </div>
    </div>
</div>

<script>
// AI On-Chain Configuration Functions

function updateAIConfidenceDisplay(value) {
    document.getElementById('aiConfidenceValue').textContent = parseFloat(value).toFixed(2);
}

function updateFlashProfitDisplay(value) {
    document.getElementById('flashProfitValue').textContent = parseFloat(value).toFixed(2);
}

function updateGrowthMultiplier() {
    const current = parseFloat(document.getElementById('currentCapitalEth').value) || 100;
    const target = parseFloat(document.getElementById('targetCapitalEth').value) || 1000;
    const multiplier = (target / current).toFixed(1);
    document.getElementById('growthMultiplier').textContent = multiplier + 'x';
}

// Update growth multiplier when capital values change
document.addEventListener('DOMContentLoaded', function() {
    const currentCapital = document.getElementById('currentCapitalEth');
    const targetCapital = document.getElementById('targetCapitalEth');

    if (currentCapital) currentCapital.addEventListener('input', updateGrowthMultiplier);
    if (targetCapital) targetCapital.addEventListener('input', updateGrowthMultiplier);

    updateGrowthMultiplier();
});

// Preset configurations for optimal flash loan profitability
const AI_PRESETS = {
    conservative: {
        aiMode: 'conservative',
        confidence: 0.75,
        flashProfit: 0.20,
        kellyFraction: 0.25,
        maxLeverage: 2.0,
        currentCapital: 100,
        targetCapital: 500,
        maxDailyLosses: 300,
        maxConcurrent: 2
    },
    balanced: {
        aiMode: 'balanced',
        confidence: 0.70,
        flashProfit: 0.15,
        kellyFraction: 0.30,
        maxLeverage: 3.0,
        currentCapital: 100,
        targetCapital: 1000,
        maxDailyLosses: 500,
        maxConcurrent: 3
    },
    aggressive: {
        aiMode: 'aggressive',
        confidence: 0.60,
        flashProfit: 0.10,
        kellyFraction: 0.35,
        maxLeverage: 5.0,
        currentCapital: 100,
        targetCapital: 2000,
        maxDailyLosses: 1000,
        maxConcurrent: 5
    }
};

function applyAIPreset(presetName) {
    const preset = AI_PRESETS[presetName];
    if (!preset) return;

    // Apply all preset values
    document.getElementById('aiModeSelect').value = preset.aiMode;
    document.getElementById('aiOnChainConfidence').value = preset.confidence;
    document.getElementById('flashLoanMinProfit').value = preset.flashProfit;
    document.getElementById('kellyFraction').value = preset.kellyFraction;
    document.getElementById('maxLeverage').value = preset.maxLeverage;
    document.getElementById('currentCapitalEth').value = preset.currentCapital;
    document.getElementById('targetCapitalEth').value = preset.targetCapital;
    document.getElementById('maxDailyLosses').value = preset.maxDailyLosses;
    document.getElementById('maxConcurrent').value = preset.maxConcurrent;

    // Update displays
    updateAIConfidenceDisplay(preset.confidence);
    updateFlashProfitDisplay(preset.flashProfit);
    updateGrowthMultiplier();

    // Show success message
    showAlert(`Applied ${presetName.toUpperCase()} preset for flash loan optimization`, 'success');

    // Automatically apply the config
    setTimeout(() => applyAIOnChainConfig(), 500);
}

async function applyAIOnChainConfig() {
    const config = {
        // AI Mode and Orchestration
        ai_mode: document.getElementById('aiModeSelect').value,
        enable_ai_orchestration: document.getElementById('enableAIOrchestration').checked,
        enable_profit_maximization: document.getElementById('enableProfitMaximization').checked,
        enable_ml_scoring: document.getElementById('enableMLScoring').checked,

        // Capital and Targets
        current_capital_eth: parseFloat(document.getElementById('currentCapitalEth').value),
        target_capital_eth: parseFloat(document.getElementById('targetCapitalEth').value),

        // Decision Thresholds
        ai_min_confidence: parseFloat(document.getElementById('aiOnChainConfidence').value),
        flash_loan_min_profit_eth: parseFloat(document.getElementById('flashLoanMinProfit').value),

        // Position Sizing
        kelly_fraction: parseFloat(document.getElementById('kellyFraction').value),
        max_leverage: parseFloat(document.getElementById('maxLeverage').value),

        // Risk Management
        max_daily_losses_usd: parseFloat(document.getElementById('maxDailyLosses').value),
        max_concurrent_executions: parseInt(document.getElementById('maxConcurrent').value),

        // Execution Controls
        enable_flash_loans: document.getElementById('enableFlashLoans').checked
    };

    try {
        const response = await fetch('/api/ai/onchain/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });

        const data = await response.json();

        if (response.ok) {
            showAlert('‚úÖ AI On-Chain configuration applied successfully!', 'success');
            updateAIOnChainStatus(config);

            // Also update the AI Settings endpoint
            await updateAISystemConfig(config);
        } else {
            showAlert(`‚ùå Failed to apply config: ${data.detail || 'Unknown error'}`, 'error');
        }
    } catch (error) {
        console.error('Error applying AI on-chain config:', error);
        showAlert('‚ùå Error applying configuration', 'error');
    }
}

async function updateAISystemConfig(config) {
    // Update the unified AI system config
    try {
        const aiConfig = {
            ai_mode: config.ai_mode,
            enable_ai_system: config.enable_ai_orchestration,
            ai_min_confidence: config.ai_min_confidence,
            enable_ml_scoring: config.enable_ml_scoring,
            kelly_fraction: config.kelly_fraction,
            max_leverage: config.max_leverage,
            portfolio_value_eth: config.current_capital_eth
        };

        await fetch('/api/ai/config/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(aiConfig)
        });
    } catch (error) {
        console.error('Error updating AI system config:', error);
    }
}

function updateAIOnChainStatus(config) {
    const statusEl = document.getElementById('aiOnChainStatus');
    if (config.enable_ai_orchestration) {
        statusEl.textContent = 'ACTIVE';
        statusEl.style.background = '#d1fae5';
        statusEl.style.color = '#065f46';
    } else {
        statusEl.textContent = 'OFF';
        statusEl.style.background = '#fef3c7';
        statusEl.style.color = '#92400e';
    }
}

// Load AI stats periodically
async function loadAIOnChainStats() {
    try {
        const response = await fetch('/api/ai/onchain/stats');
        if (!response.ok) return;

        const data = await response.json();

        // Update stats display
        if (data.ai_decisions_made !== undefined) {
            document.getElementById('aiDecisionsCount').textContent = data.ai_decisions_made;
        }
        if (data.ai_decisions_executed !== undefined) {
            document.getElementById('aiExecutionsCount').textContent = data.ai_decisions_executed;
        }
        if (data.win_rate !== undefined) {
            const winRate = (data.win_rate * 100).toFixed(1);
            document.getElementById('aiWinRate').textContent = winRate + '%';
        }
        if (data.progress_pct !== undefined) {
            document.getElementById('aiProgress').textContent = data.progress_pct.toFixed(1) + '%';
        }
    } catch (error) {
        console.error('Error loading AI on-chain stats:', error);
    }
}

// Poll for stats every 5 seconds
setInterval(loadAIOnChainStats, 5000);

// Helper function to show alerts
function showAlert(message, type = 'info') {
    const alertsDiv = document.getElementById('alerts');
    if (!alertsDiv) return;

    const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-warning' : 'alert';
    const alert = document.createElement('div');
    alert.className = alertClass;
    alert.innerHTML = `<strong>${message}</strong>`;
    alert.style.marginBottom = '10px';

    alertsDiv.appendChild(alert);

    // Auto-remove after 5 seconds
    setTimeout(() => alert.remove(), 5000);
}
</script>

<!-- Additional CSS if needed -->
<style>
.config-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
}

.config-grid input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    height: 6px;
    border-radius: 3px;
    background: #e5e7eb;
    outline: none;
}

.config-grid input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #f59e0b;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.config-grid input[type="range"]::-moz-range-thumb {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #f59e0b;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    border: none;
}
</style>
